<%- include ./header.ejs %>
<% const imgTagHeader = '<img src=\"'; %>
<% const imgTagFooter = '"/>'; %>
<% const aTagHeader = '<a class="list_button" onclick="showDialog(this, \''; %>
<% const aTagFooter = '\')">'; %>
    <header>
        <nav id="main_nav">
                <div id='cssmenu'>
                        <ul>
                            <li><a href='/img'>照片審核</a>
                            </li>
                            <li><a href='/checkedList'>審核紀錄</a>
                            </li>
                            <li class='active'><a>對話管理</a>
                            </li>
                        </ul>
                </div>
                <b id="goodtogo">LINE BOT 後台</b>
        </nav>
    </header>
    <div id="messenger_view">
        <div class="manager">
            <form class="form-wrapper">
                <input type="text" id="search" placeholder=" 輸入id搜尋..." required>
            </form>
            <ul id="customers_list">
                <% var imgTag = ''; %>
                <% var aTag = ''; %>
                <% for(var i = 0; i < ((roomList.length > 20)? 20:roomList.length); i++){ %>
                <% imgTag = imgTagHeader + roomList[i].userImg + imgTagFooter; %>
                <% aTag = aTagHeader + roomList[i].userId + aTagFooter; %>
                <li><%- aTag %><%- imgTag %><span class="helper"></span><p><%- roomList[i].userName %></p></a></li>
                <% } %>
            </ul>
        </div>
        <div class="message" id='message'>
            <div id="message_field">
                <nav id="customer_id"><a class="back_button" onclick="closeDialog()">ㄑ</a><p></p></nav>
                <ul id="message_ul">
                    <li class='me'><span class="helper"></span><p><a class='box'>asdsasa</a></p></li>
                    <li class='customer'><span class="helper customer"><img /></span><p><a class='box'>asdsds33333333333</a></p></li>
                </ul>
            </div>
            <div id="text_field">
                <span class="helper"></span>
                <input id='search_img_btn' type='button'/>
                <input id='search_img_text' placeholder='照片編號...' type='text'/>
                <input id='search_img_send' type='button' />
                <input id="message_text" type='text' placeholder=" 輸入訊息..." autocomplete="off"/>
                <input id='sendMsg' type='submit' />
            </div>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
    <% var tmpArr = []; %>
    <% if(roomList.length > 20) tmpArr = roomList.slice(20, roomList.length); %>
    <% var arrStr = ''; %>
    <% for(var i = 0; i < tmpArr.length; i++) arrStr += JSON.stringify(tmpArr[i]) + (((i+1) === tmpArr.length)? '':', '); %>
    <% var tmpStr = '[' + arrStr + ']'; %>
    var extraRoomList = <%- tmpStr %>;
    var socket = io.connect(window.location.origin);

    var isSearchImgButtonSelected = false;

    socket.on('server', function(obj){
        console.log('msg: ' + obj.msg)
    })

    $('#sendMsg').on('click', function(){
         var msg = document.getElementById('message_text').value;
        if (msg === '') {
            return;
        }

        create_message('me', msg);

        socket.emit('sendMsg', {userId:selected_customer.getAttribute('customerId'), msg:msg});
        document.getElementById('message_text').value = '';
    })

    $('#message_text').keydown(function(event){
        if ( event.which == 13 ){
            $('#sendMsg').click();
        }
    });

    $('#search_img_btn').on('click', function(){
        if (!isSearchImgButtonSelected) {
            this.style.marginRight = '0px';
            document.getElementById('message_text').style.width = ('calc(90% - 40px - 120px)');
            document.getElementById('search_img_text').style.display = 'inline-block';
            document.getElementById('search_img_send').style.display = 'inline-block';
        } else {
            this.style.marginRight = '10px';
            document.getElementById('message_text').style.width = ('calc(90% - 40px)');
            document.getElementById('search_img_text').style.display = 'none';
            document.getElementById('search_img_send').style.display = 'none';
        }

        isSearchImgButtonSelected = !isSearchImgButtonSelected;
    });

    $('#search_img_text').keydown(function(event){
        if ( event.which == 13 ){
            $('#search_img_btn').click();
        }
    });

    $('#search_img_send').on('click', function(){
        let search_id = document.getElementById('search_img_text').value;

        document.getElementById('search_img_btn').click();
        document.getElementById('search_img_text').value = '';

        $.ajax({
            url: 'chatroom/img/' + search_id,
            dataType: 'JSON',
            success: function(data){
                if (data.src === undefined) {
                    create_message('system','查無此照片');
                    return;
                } else if (!data.checked) {
                    create_message('system','此照片尚未審核');
                    return;
                }
                var new_img = document.createElement('img');
                new_img.setAttribute('src', 'http://bot.goodtogo.tw'+data.src);
                var upload_time = custom_date(new Date(data.uploadTime));
                var checked_time = custom_date( new Date(data.checkStatus.checkedTime));
                var amount = data.checkStatus.amount;
                if (amount === undefined) {
                    amount = '0 (' + reasons[data.checkStatus.typeCode] + ')';
                }
                var img_index = data.imgIndex;

                var msg = '照片編號: ' + img_index + '\n上傳時間: ' + upload_time + '\n審核時間: ' + checked_time + '\n審核結果: ' + amount; 
                create_message('system', msg, new_img);
            }
        })
    })

    </script>
<%- include ./footer.ejs %>