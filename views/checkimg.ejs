<%- include ./header.ejs %>
    <header>
        <nav id="main_nav">
            <div id='cssmenu'>
                <ul>
                    <li class='active'><a>照片審核</a>
                    </li>
                    <li><a href='/chatroom'>對話管理</a>
                    </li>
                </ul>
            </div>
            <b id="goodtogo">LINE BOT 後台</b>
        </nav>
    </header>
    <div id="blocker">
        <div id="picture_view">
        </div>
    </div>
    <div id="detail">
        <div id="detail_pic">
            <span class="helper"></span>
            <div id="main_pic_section">
                <span class="helper"></span>
                <img id="main_pic" alt="main_pic" />
            </div>
        </div>

        <div id="detail_data">
            <span class="helper"></span>
            <div class="data_container">
                <div class="data">
                    <a id="user_id_title">使用者 id: </a>
                    <p id="user_id">e.zou.shen59</p>
                    <a id="upload_time_title">上傳時間: </a>
                    <p id="upload_time"></p>
                </div>
                <div class="detail">
                    <p>可兌換抽獎次數: <input type="number" /></p>
                    <p>資格不承認原因:
                        <select name="reasons">
                                    <option value="not_at_the_site">不在現場</option>
                                    <option value="not_our_container">容器非好盒器</option>
                                </select>
                    </p>
                    <p id="status">＊此照片尚未經過首次審核</p>
                    <button onclick="submit">保存</button>
                </div>
            </div>
        </div>
    <script>
        var lastIndex = <%- lastIndex %>
        
        load_pic_data(lastIndex);

        var should_update = true;

        $( "#picture_view" ).on( "scroll", function() {
            if ((this.scrollLeft+this.clientWidth) >= this.scrollWidth) {
                if (should_update === true) {
                    
                    should_update = false;

                    this.scrollLeft = this.scrollWidth;

                    var new_pic = [];

                    $.ajax({
                        url: "/img/new/" + (end_index+1),
                        type: "GET",
                        dataType: "JSON",
                        success: function(data){
                            console.log(data.list.length);
                            new_pic = data.list;
                            pic_data.concat(new_pic);
                        },
                        error: function(){
                            console.log('error');                            
                        },
                        complete: function(){
                            should_update = true;

                            let gallery = this;
            
                            end_index += new_pic.length;

                            for( var i=0; i<new_pic.length; i++){
                                var imgstr = "data:" + new_pic[i].imgType + ";base64," + new_pic[i].imgBinary;
                                var imgtag = document.createElement('img');
                                imgtag.setAttribute('class','button');
                                imgtag.setAttribute('type', 'button');
                                imgtag.setAttribute('src', imgstr);
                                imgtag.setAttribute('onclick', "select_picture(this)");

                                var container = document.createElement('div');
                                container.setAttribute('class', 'container');

                                var pic_a = document.createElement('a');
                                pic_a.setAttribute('class', 'pic');

                                pic_a.appendChild(imgtag);

                                if (pic_data[i].checked) {
                                    var img = document.createElement('img');
                                    img.setAttribute('class', 'icon');
                                    img.setAttribute('src', '/assets/icon/checked.png');

                                    pic_a.appendChild(img);
                                }

                                var name_p = document.createElement('p');
                                name_p.appendChild(document.createTextNode(new_pic[i].userName));

                                pic_a.appendChild(name_p);

                                container.appendChild(pic_a);

                                gallery.appendChild(container);
                            }
            
                            gallery.scrollLeft = gallery.scrollWidth;
                        }    
                    });
                }
            }

            if ((this.scrollLeft+this.clientWidth)<0 && start_index>0) {
                if (should_update) {
                    should_update = false;

                    this.scrollLeft = this.scrollWidth;

                    var new_pic = [];

                    $.ajax({
                        url: "/img/old/" + (start_index-1),
                        type: "GET",
                        dataType: "JSON",
                        success: function(data){
                            console.log(data.list.length);
                            new_pic = data.list;
                            pic_data.concat(new_pic);
                        },
                        error: function(){
                            console.log('error');                            
                        },
                        complete: function(){
                            should_update = true;

                            let gallery = this;
            
                            end_index += new_pic.length;

                            for( var i=0; i<new_pic.length; i++){
                                var imgstr = "data:" + new_pic[i].imgType + ";base64," + new_pic[i].imgBinary;
                                var imgtag = document.createElement('img');
                                imgtag.setAttribute('class','button');
                                imgtag.setAttribute('type', 'button');
                                imgtag.setAttribute('src', imgstr);
                                imgtag.setAttribute('onclick', "select_picture(this)");

                                var container = document.createElement('div');
                                container.setAttribute('class', 'container');

                                var pic_a = document.createElement('a');
                                pic_a.setAttribute('class', 'pic');

                                pic_a.appendChild(imgtag);

                                if (pic_data[i].checked) {
                                    var img = document.createElement('img');
                                    img.setAttribute('class', 'icon');
                                    img.setAttribute('src', '/assets/icon/checked.png');

                                    pic_a.appendChild(img);
                                }

                                var name_p = document.createElement('p');
                                name_p.appendChild(document.createTextNode(new_pic[i].userName));

                                pic_a.appendChild(name_p);

                                container.appendChild(pic_a);

                                gallery.insertBefore(container, gallert.firstNode);
                            }
                        }    
                    });
                }
            }
        });

    </script>
<%- include ./footer.ejs %>